<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css">
		<!-- <link rel="stylesheet" href="https://sugar.wtf/wizardry.min.css">
		<link rel="stylesheet" href="https://sugar.wtf/entypo/entypo.css"> -->
		
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/js/bootstrap.min.js"></script>
		<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>
		<script src="https://code.highcharts.com/highcharts.src.js"></script>
		<script src="https://code.highcharts.com/modules/exporting.js"></script>
		<script src="https://code.highcharts.com/modules/export-data.js"></script>
		<script src="https://code.highcharts.com/modules/accessibility.js"></script> -->
		
		<link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32.png">
		<!-- <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro&display=swap" rel="stylesheet"> -->
		<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
		<link rel="stylesheet" href="css/style.css">
		<link rel="stylesheet" href="css/entypo.css">
		<title>Blockchain Explorer</title>
		<meta name="description" content="AdventureCoin Blockchain Explorer">

		<link rel="manifest" href="manifest.json">
		<meta name="theme-color" content="#000000">

	</head>
	<body>
		<!-- Navbar -->
		<nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark">
			<div class="container">
				<a href="#" class="navbar-brand">
					<img src="img/advc.svg" alt="Logo">
					<b>Explorer</b>
				</a>
				<button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
					<span class="navbar-toggler-icon"></span>
				</button>
				<div class="collapse navbar-collapse" id="navbarResponsive">
					<ul class="navbar-nav ml-auto">
						<li class="nav-item">
							<a href="index.html" class="nav-link">Home</a>
						</li>
						<li class="nav-item dropdown" id="wallets">
                            <a class="nav-link dropdown-toggle" href="#" id="wallets" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Wallets Info
                            </a>
                            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="wallets">
                                <a class="dropdown-item" href="/wallet/#/">Web Wallet</a>
								<a class="dropdown-item" href="/paper-wallets/walletgen.html">Paper Wallet</a>
                            </div>
                        </li>
                        <li class="nav-item dropdown" id="peers">
                            <a class="nav-link dropdown-toggle" href="#" id="peers" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Peer Info
                            </a>
                            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="peers">
                                <a class="dropdown-item" href="addnodes.html">AddNodes</a>
                                <a class="dropdown-item" href="peers.html">Peers</a>
                            </div>
                        </li>
						<li class="nav-item">
							<a href="https://api.adventurecoin.quest" class="nav-link">API</a>
						</li>
						<li class="nav-item">
							<a href="https://adventurecoin.quest" class="nav-link">Website</a>
						</li>
						<li class="nav-item dropdown" id="network-list">
							<a class="nav-item nav-link dropdown-toggle" href="#" id="network-versions" data-toggle="dropdown">NETWORK</a>
						  	<div class="dropdown-menu dropdown-menu-right" aria-labelledby="network-versions" >
						  	</div>
						</li>
					</ul>
				</div>
			</div>
		</nav>
		
		<!-- Error message and search -->
		<div class="container">
			<div id="error-message" class="alert alert-warning d-none" role="alert">
				Error, yay ∠( ᐛ 」∠)
			</div>
			<div class="card mb-3">
				<div class="card-body">
					<form id="search-form">
						<div class="input-group">
							<input type="text" id="search-field" name="search-field" class="form-control" placeholder="Block, hash, transaction, etc..." aria-label="Recipient's username" aria-describedby="button-addon2">
							<div class="input-group-append">
								<button class="btn btn-outline-dark" type="submit" id="button-addon2">Search!</button>
							</div>
						</div>
					</form>
				</div>
			</div>
		</div>
	
		<!-- Home page -->
        <div id="homepage" class="router-page">
            <div class="container">

                <div class="row mt-5">
                    <!-- Sidebar Filters -->
                    <div class="col-md-3">
                        <div class="card mb-3">
                            <div class="card-header font-weight-bold">Filters</div>
                            <div class="card-body">
                                <div class="form-group">
                                    <label for="filter-version">Version:</label>
                                    <select id="filter-version" class="form-control">
                                        <option value="">All Versions</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Countries:</label>
                                    <div id="country-checkboxes" style="max-height: 800px; overflow-y: auto;"></div>
                                </div>
                                <button id="reset-filters" class="btn btn-secondary btn-sm btn-block">Reset Filters</button>
                            </div>
                        </div>
                    </div>

                    <!-- Main Map + Stats -->
                    <div class="col-md-9">
                        <!-- Stats -->
                        <div class="row text-center mb-3">
                            <div class="col-sm">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h5 id="stat-nodes">0</h5>
                                        <small>Unique Nodes</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h5 id="stat-countries">0</h5>
                                        <small>Countries</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h5 id="stat-versions">0</h5>
                                        <small>Versions</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h5 id="stat-time">--:--</h5>
                                        <small>Last Updated</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Map -->
                        <div id="node-map" style="height: 500px;"></div>

                        <!-- Node Table -->
                        <div class="card mt-3">
                            <div class="card-header font-weight-bold">Node List</div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-sm mb-0">
                                        <thead class="thead-dark">
                                            <tr>
                                                <th>IP Address</th>
                                                <th>Country</th>
                                                <th>Version</th>
                                            </tr>
                                        </thead>
                                        <tbody id="node-table"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Leaflet CSS & JS -->
                <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
                <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
                <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
                <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
                <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>


                <script>
                document.addEventListener("DOMContentLoaded", () => {
                    const map = L.map("node-map").setView([20, 0], 2);
                    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                        attribution: '© Adventurecoin contributors',
                        maxZoom: 18,
                    }).addTo(map);
                    const markers = L.markerClusterGroup();

                    const customIcon = L.icon({
                    iconUrl: '/img/favicon-32.png',       // Path to your logo
                    iconSize: [32, 32],        // Size of the icon
                    iconAnchor: [16, 32],      // Point of the icon which corresponds to marker's location
                    popupAnchor: [0, -32]      // Where the popup opens relative to the iconAnchor
                    });


                    const countryCounts = {};
                    const versions = new Set();
                    const nodes = [];

                    fetch("https://api.adventurecoin.quest/peers")
                        .then(res => res.json())
                        .then(data => {
                            const peers = data.result || [];
                            const uniqueIPs = new Set();

                            peers.forEach(peer => {
                                let ip = peer.addr;
                                if (ip.startsWith("[") && ip.includes("]")) ip = ip.slice(1, ip.indexOf("]"));
                                else if (ip.includes(":")) ip = ip.split(":")[0];

                                if (!uniqueIPs.has(ip)) {
                                    uniqueIPs.add(ip);

                                    fetch(`https://get.geojs.io/v1/ip/geo/${ip}.json`)
                                        .then(r => r.json())
                                        .then(loc => {
                                            const country = loc.country || "Unknown";
                                            const version = peer.subver || "Unknown";


                                            countryCounts[country] = (countryCounts[country] || 0) + 1;
                                            versions.add(version);


                                            const marker = L.marker([loc.latitude, loc.longitude], { icon: customIcon })
                                                .bindPopup(`<b>${ip}</b><br>${loc.city}, ${loc.country}`);
                                            marker.meta = { ip, country, version };
                                            markers.addLayer(marker);

                                            nodes.push({ marker, meta: marker.meta });
                                            updateStats();
                                            updateFilters();
                                            renderTable();
                                        });
                                }
                            });

                            map.addLayer(markers);
                        });

                    function updateStats() {
                        document.getElementById("stat-nodes").textContent = nodes.length;
                        document.getElementById("stat-countries").textContent = Object.keys(countryCounts).length;
                        document.getElementById("stat-versions").textContent = versions.size;
                        document.getElementById("stat-time").textContent = new Date().toLocaleTimeString();
                    }

                    function updateFilters() {
                    const countryContainer = document.getElementById("country-checkboxes");
                    const versionSelect = document.getElementById("filter-version");

                    countryContainer.innerHTML = Object.keys(countryCounts)
                        .sort()
                        .map(c => `<div><input type="checkbox" class="country-filter" value="${c}" checked> ${c}</div>`)
                        .join("");

                    versionSelect.innerHTML = '<option value="">All Versions</option>' +
                        Array.from(versions).map(v => `<option value="${v}">${v}</option>`).join("");

                    countryContainer.querySelectorAll("input").forEach(input => {
                        input.addEventListener("change", applyFilters);
                    });
                    versionSelect.addEventListener("change", applyFilters);
                    document.getElementById("reset-filters").addEventListener("click", resetFilters);
                }


                    function applyFilters() {
                    const selectedCountries = Array.from(document.querySelectorAll(".country-filter:checked")).map(el => el.value);
                    const selectedVersion = document.getElementById("filter-version").value;

                    markers.clearLayers();

                    const filtered = nodes.filter(n => {
                        return selectedCountries.includes(n.meta.country) &&
                            (!selectedVersion || n.meta.version === selectedVersion);
                    });

                    filtered.forEach(n => markers.addLayer(n.marker));
                    renderTable(filtered.map(n => n.meta));
                }


                    function resetFilters() {
                        document.querySelectorAll(".country-filter").forEach(el => el.checked = true);
                        document.getElementById("filter-version").value = "";
                        applyFilters();
                    }

                    function renderTable(filtered = nodes.map(n => n.meta)) {
                    const tbody = document.getElementById("node-table");
                    tbody.innerHTML = filtered.map(n => `
                        <tr>
                            <td>${n.ip}</td>
                            <td>${n.country}</td>
                            <td>${n.version}</td>
                        </tr>
                    `).join("");
                }

                });
                </script>
            </div>
        </div>
	
		
		<!-- Footer :3 -->
		<footer class="mb-3">
			<div class="container text-center">
				Made with <span class="entypo heart text-danger"></span> by <a target="_blank" href="https://discord.gg/vrvfhQ4FRa">Crypto Development Services</a>
			</div>
		</footer>

		<!-- All magic is here :D -->
		<script src="js/config.js"></script>
		<script src="js/errorMessages.js"></script>
		<!-- <script src="js/charts.js"></script> -->
		<script src="js/convertHashes.js"></script>
		<script src="js/displayDocs.js"></script>
		<script src="js/api.js"></script>
		<script src="js/router.js"></script>
		<script src="js/title.js"></script>
		<script src="js/api-endpoints.js"></script>
		<script src="js/displayBlock.js"></script>
		<script src="js/displayBlockInfo.js"></script>
		<script src="js/addressLabels.js"></script>
		<script src="js/displayTransactionInfo.js"></script>
		<script src="js/showQrModal.js"></script>
		<script src="js/displayAddressInfo.js"></script>
		<script src="js/parseTransactionDetails.js"></script>
		<script src="js/displayTransactionInfo.js"></script>
		<script src="js/loadTransactions.js"></script>
		<script src="js/displayTransactions.js"></script>
		<script src="js/displayTxVout.js"></script>
		<script src="js/displayTxVin.js"></script>
		<script src="js/displayHistory.js"></script>
		<script src="js/displayHome.js"></script>
		<script src="js/loadPeers.js"></script>
        <script src="js/loadAddNodes.js"></script>
		<script src="js/amountFormat.js"></script>
		<script src="js/timeFormat.js"></script>
		<script src="js/showError.js"></script>
		<script src="js/base58Data.js"></script>
		<script src="js/bech32Decode.js"></script>
		<script src="js/convertBits.js"></script>
		<script src="js/bech32Data.js"></script>
		<script src="js/hexString.js"></script>
		<script src="js/hash160.js"></script>
		<script src="js/initRouter.js"></script>
		<script src="js/magic.js"></script>
		<script src="js/cookies.js"></script>
	</body>
</html>
